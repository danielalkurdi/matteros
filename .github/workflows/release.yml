name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build_release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
      sha256: ${{ steps.meta.outputs.sha256 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build distributions
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Compute artifact metadata
        id: meta
        run: |
          version="$(python - <<'PY'
          import pathlib, tomllib
          pyproject = pathlib.Path("pyproject.toml")
          print(tomllib.loads(pyproject.read_text(encoding="utf-8"))["project"]["version"])
          PY
          )"
          tag="${{ github.event.inputs.tag || github.ref_name }}"
          sha256="$(sha256sum "dist/matteros-${version}.tar.gz" | awk '{print $1}')"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "sha256=${sha256}" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          files: |
            dist/*.tar.gz
            dist/*.whl
          generate_release_notes: true

  update_homebrew_tap:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: build_release
    if: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN != '' }}
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Update tap formula
        env:
          TAP_REPO: danielalkurdi/homebrew-matteros
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          VERSION: ${{ needs.build_release.outputs.version }}
          TAG: ${{ needs.build_release.outputs.tag }}
          SHA256: ${{ needs.build_release.outputs.sha256 }}
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${TAP_REPO}.git" tap
          mkdir -p tap/Formula

          sed \
            -e "s/__VERSION__/${VERSION}/g" \
            -e "s/__TAG__/${TAG}/g" \
            -e "s/__SHA256__/${SHA256}/g" \
            packaging/homebrew/matteros.rb.tmpl > tap/Formula/matteros.rb

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/matteros.rb
          git commit -m "matteros ${TAG}" || echo "No formula changes"
          git push
